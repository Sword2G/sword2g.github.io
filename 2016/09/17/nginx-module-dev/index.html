<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Nginx," />





  <link rel="alternate" href="http://sword2g.github.io/atom.xml" title="No root,no fruit" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="编写一个 nginx handler 模块实现 hello XX。">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx 模块开发————Hello XX">
<meta property="og:url" content="https://github.com/Sword2G/sword2g.github.io/2016/09/17/nginx-module-dev/index.html">
<meta property="og:site_name" content="No root,no fruit">
<meta property="og:description" content="编写一个 nginx handler 模块实现 hello XX。">
<meta property="og:updated_time" content="2017-05-08T10:08:54.255Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Nginx 模块开发————Hello XX">
<meta name="twitter:description" content="编写一个 nginx handler 模块实现 hello XX。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://github.com/Sword2G/sword2g.github.io/2016/09/17/nginx-module-dev/"/>





  <title> Nginx 模块开发————Hello XX | No root,no fruit </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">No root,no fruit</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">just do it！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/resume.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://github.com/Sword2G/sword2g.github.io/2016/09/17/nginx-module-dev/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sword2g">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xum8m.com1.z0.glb.clouddn.com/avataravatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="No root,no fruit">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Nginx 模块开发————Hello XX
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-17T23:41:12+08:00">
                2016-09-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/17/nginx-module-dev/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/17/nginx-module-dev/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>编写一个 nginx handler 模块实现 hello XX。<br><a id="more"></a></p>
<p>nginx handler 编写步骤如下：</p>
<ul>
<li><p>编写模块基本结构，包括模块的配置结构模块上下文结构，模块的定义等。</p>
</li>
<li><p>实现handler的挂载函数，根据模块的需求选择正确的挂载方式。</p>
</li>
<li><p>编写handler处理函数，模块的功能主要通过这个函数来完成。</p>
</li>
</ul>
<h1 id="模块配置结构"><a href="#模块配置结构" class="headerlink" title="模块配置结构"></a>模块配置结构</h1><p>每个模块都会提供一些配置指令，以便于用户可以通过配置来控制该模块的行为。<br>用于存放模块配置信息的结构，命名习惯是ngx<em>http</em><em>module name</em>_(main|srv|loc)_conf_t,如这里的hello模块的配置信息结构定义如下<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">ngx_str_t</span> hello_string;</div><div class="line">&#125;<span class="keyword">ngx_http_hello_loc_conf_t</span>;</div></pre></td></tr></table></figure></p>
<h1 id="模块配置指令（commands-数组）"><a href="#模块配置指令（commands-数组）" class="headerlink" title="模块配置指令（commands 数组）"></a>模块配置指令（commands 数组）</h1><p>commands 数组用于模块配置指令的定义。数组中的每一个元素都是ngx_command_t类型，数组的结尾用ngx_null_command结束。Nginx在解析配置文件的时候，会通过遍历每一个模块的commands数组来解析遇到的指令，当遇到 ngx_null_command 时，会停止当前模块指令的解析。</p>
<h2 id="ngx-command-t-定义"><a href="#ngx-command-t-定义" class="headerlink" title="ngx_command_t 定义"></a>ngx_command_t 定义</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> ngx_command_s <span class="keyword">ngx_command_t</span>;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> ngx_command_s &#123;</div><div class="line">	<span class="comment">// 配置指令的名称</span></div><div class="line">    <span class="keyword">ngx_str_t</span>             name;</div><div class="line">    <span class="comment">// 配置的类型(详细介绍如下)</span></div><div class="line">    <span class="keyword">ngx_uint_t</span>            type;</div><div class="line">    <span class="comment">// 出现name 指令时会调用set方法来处理配置参数(详细介绍如下)</span></div><div class="line">    <span class="keyword">char</span>               *(*<span class="built_in">set</span>)(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf);</div><div class="line">    </div><div class="line">    <span class="keyword">ngx_uint_t</span>            conf;</div><div class="line"></div><div class="line">    <span class="keyword">ngx_uint_t</span>            offset;</div><div class="line"> </div><div class="line">    <span class="keyword">void</span>                 *post;</div><div class="line">    <span class="comment">/*</span></div><div class="line">    该字段存储一个指针。可以指向任何一个在读取配置过程中需要的数据，以便于进行配置读取的处理。大多数时候，都不需要，所以简单地设为0即可。</div><div class="line">    */</div><div class="line">&#125;;</div><div class="line"></div><div class="line">##<span class="meta"># type参数</span></div><div class="line"></div><div class="line">该配置的类型，其实更准确一点说，是该配置指令属性的集合。nginx提供了很多预定义的属性值（一些宏定义），通过逻辑或运算符可组合在一起，形成对这个配置指令的详细的说明。下面列出可在这里使用的预定义属性值及说明。</div><div class="line">NGX_CONF_NOARGS：配置指令不接受任何参数。</div><div class="line">NGX_CONF_TAKE1：配置指令接受<span class="number">1</span>个参数。</div><div class="line">NGX_CONF_TAKE2：配置指令接受<span class="number">2</span>个参数。</div><div class="line">NGX_CONF_TAKE3：配置指令接受<span class="number">3</span>个参数。</div><div class="line">NGX_CONF_TAKE4：配置指令接受<span class="number">4</span>个参数。</div><div class="line">NGX_CONF_TAKE5：配置指令接受<span class="number">5</span>个参数。</div><div class="line">NGX_CONF_TAKE6：配置指令接受<span class="number">6</span>个参数。</div><div class="line">NGX_CONF_TAKE7：配置指令接受<span class="number">7</span>个参数。</div><div class="line"></div><div class="line">可以组合多个属性，比如一个指令即可以不填参数，也可以接受<span class="number">1</span>个或者<span class="number">2</span>个参数。那么就是NGX_CONF_NOARGS|NGX_CONF_TAKE1|NGX_CONF_TAKE2。如果写上面三个属性在一起，你觉得麻烦，那么没有关系，nginx提供了一些定义，使用起来更简洁。</div><div class="line"></div><div class="line">NGX_CONF_TAKE12：配置指令接受<span class="number">1</span>个或者<span class="number">2</span>个参数。</div><div class="line">NGX_CONF_TAKE13：配置指令接受<span class="number">1</span>个或者<span class="number">3</span>个参数。</div><div class="line">NGX_CONF_TAKE23：配置指令接受<span class="number">2</span>个或者<span class="number">3</span>个参数。</div><div class="line">NGX_CONF_TAKE123：配置指令接受<span class="number">1</span>个或者<span class="number">2</span>个或者<span class="number">3</span>参数。</div><div class="line">NGX_CONF_TAKE1234：配置指令接受<span class="number">1</span>个或者<span class="number">2</span>个或者<span class="number">3</span>个或者<span class="number">4</span>个参数。</div><div class="line">NGX_CONF_1MORE：配置指令接受至少一个参数。</div><div class="line">NGX_CONF_2MORE：配置指令接受至少两个参数。</div><div class="line">NGX_CONF_MULTI: 配置指令可以接受多个参数，即个数不定。</div><div class="line">NGX_CONF_BLOCK：配置指令可以接受的值是一个配置信息块。也就是一对大括号括起来的内容。里面可以再包括很多的配置指令。比如常见的server指令就是这个属性的。</div><div class="line"></div><div class="line">NGX_CONF_FLAG：配置指令可以接受的值是”on”或者”off”，最终会被转成<span class="keyword">bool</span>值。</div><div class="line"></div><div class="line">NGX_CONF_ANY：配置指令可以接受的任意的参数值。一个或者多个，或者”on”或者”off”，或者是配置块。</div><div class="line"></div><div class="line">最后要说明的是，无论如何，nginx的配置指令的参数个数不可以超过NGX_CONF_MAX_ARGS个。目前这个值被定义为<span class="number">8</span>，也就是不能超过<span class="number">8</span>个参数值。</div><div class="line"></div><div class="line">下面介绍一组说明配置指令可以出现的位置的属性。</div><div class="line">NGX_DIRECT_CONF：可以出现在配置文件中最外层。例如已经提供的配置指令daemon，master_process等。</div><div class="line">NGX_MAIN_CONF: http、mail、events、error_log等。</div><div class="line">NGX_ANY_CONF: 该配置指令可以出现在任意配置级别上。</div><div class="line"></div><div class="line">对于我们编写的大多数模块而言，都是在处理http相关的事情，也就是所谓的都是NGX_HTTP_MODULE，对于这样类型的模块，其配置可能出现的位置也是分为直接出现在http里面，以及其他位置。</div><div class="line"></div><div class="line">NGX_HTTP_MAIN_CONF: 可以直接出现在http配置指令里。</div><div class="line">NGX_HTTP_SRV_CONF: 可以出现在http里面的server配置指令里。</div><div class="line">NGX_HTTP_LOC_CONF: 可以出现在http server块里面的location配置指令里。</div><div class="line">NGX_HTTP_UPS_CONF: 可以出现在http里面的upstream配置指令里。</div><div class="line">NGX_HTTP_SIF_CONF: 可以出现在http里面的server配置指令里的<span class="keyword">if</span>语句所在的block中。</div><div class="line">NGX_HTTP_LMT_CONF: 可以出现在http里面的limit_except指令的block中。</div><div class="line">NGX_HTTP_LIF_CONF: 可以出现在http server块里面的location配置指令里的<span class="keyword">if</span>语句所在的block中。</div><div class="line"></div><div class="line"></div><div class="line">##<span class="meta"># set 参数 </span></div><div class="line"></div><div class="line"><span class="keyword">char</span> *(*<span class="built_in">set</span>)(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf);</div><div class="line"></div><div class="line">函数处理成功时，返回NGX_OK，否则返回NGX_CONF_ERROR或者是一个自定义的错误信息的字符串。</div><div class="line">cf: 该参数里面保存从配置文件读取到的原始字符串以及相关的一些信息。特别注意的是这个参数的args字段是一个<span class="keyword">ngx_str_t</span>类型的数组，该数组的首个元素是这个配置指令本身，第二个元素是指令的第一个参数，第三个元素是第二个参数，依次类推。</div><div class="line">cmd: 这个配置指令对应的<span class="keyword">ngx_command_t</span>结构。</div><div class="line">conf: 就是定义的存储这个配置值的结构体，比如在上面展示的那个<span class="keyword">ngx_http_hello_loc_conf_t</span>。当解析这个hello_string变量的时候，传入的conf就指向一个<span class="keyword">ngx_http_hello_loc_conf_t</span>类型的变量。</div><div class="line"></div><div class="line">预定义的<span class="built_in">set</span>：</div><div class="line">ngx_conf_set_flag_slot： 读取NGX_CONF_FLAG类型的参数。</div><div class="line">ngx_conf_set_str_slot:读取字符串类型的参数。</div><div class="line">ngx_conf_set_str_array_slot: 读取字符串数组类型的参数。</div><div class="line">ngx_conf_set_keyval_slot： 读取键值对类型的参数。</div><div class="line">ngx_conf_set_num_slot: 读取整数类型(有符号整数<span class="keyword">ngx_int_t</span>)的参数。</div><div class="line">ngx_conf_set_size_slot:读取<span class="keyword">size_t</span>类型的参数，也就是无符号数。</div><div class="line">ngx_conf_set_off_slot: 读取<span class="keyword">off_t</span>类型的参数。</div><div class="line">ngx_conf_set_msec_slot: 读取毫秒值类型的参数。</div><div class="line">ngx_conf_set_sec_slot: 读取秒值类型的参数。</div><div class="line">ngx_conf_set_bufs_slot： 读取的参数值是<span class="number">2</span>个，一个是buf的个数，一个是buf的大小。例如： output_buffers <span class="number">1</span> <span class="number">128</span>k;</div><div class="line">ngx_conf_set_enum_slot: 读取枚举类型的参数，将其转换成整数<span class="keyword">ngx_uint_t</span>类型。</div><div class="line">ngx_conf_set_bitmask_slot: 读取参数的值，并将这些参数的值以bit位的形式存储。例如：HttpDavModule模块的dav_methods指令。</div></pre></td></tr></table></figure>
<h3 id="conf-参数"><a href="#conf-参数" class="headerlink" title="conf 参数"></a>conf 参数</h3><p>该字段指定当前配置项存储的内存位置。实际上是使用哪个内存池的问题。因为http模块对所有http模块所要保存的配置信息，划分了main, server和location三个地方进行存储，每个地方都有一个内存池用来分配存储这些信息的内存。这里可能的值为 NGX_HTTP_MAIN_CONF_OFFSET、NGX_HTTP_SRV_CONF_OFFSET或NGX_HTTP_LOC_CONF_OFFSET。当然也可以直接置为0，就是NGX_HTTP_MAIN_CONF_OFFSET。</p>
<h3 id="offset-参数"><a href="#offset-参数" class="headerlink" title="offset 参数"></a>offset 参数</h3><p>指定该配置项值的精确存放位置，一般指定为某一个结构体变量的字段偏移。因为对于配置信息的存储，一般我们都是定义个结构体来存储的。那么比如我们定义了一个结构体A，该项配置的值需要存储到该结构体的b字段。那么在这里就可以填写为offsetof(A, b)。对于有些配置项，它的值不需要保存或者是需要保存到更为复杂的结构中时，这里可以设置为0。</p>
<h2 id="hello-commands-数组定义"><a href="#hello-commands-数组定义" class="headerlink" title="hello commands 数组定义"></a>hello commands 数组定义</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">ngx_command_t</span> ngx_http_hello_commands[] = &#123;  </div><div class="line">    &#123;  </div><div class="line">        ngx_string(<span class="string">"hello_string"</span>),  </div><div class="line">        NGX_HTTP_MAIN_CONF | NGX_HTTP_SRV_CONF | NGX_HTTP_LOC_CONF | NGX_HTTP_LMT_CONF | NGX_CONF_NOARGS,  </div><div class="line">        ngx_http_hello,        <span class="comment">// 出现hello配置项时，调用ngx_http_hello解析  </span></div><div class="line">        NGX_HTTP_LOC_CONF_OFFSET,  </div><div class="line">        <span class="comment">// ngx_http_hello_loc_conf_t 为模块配置信息结构</span></div><div class="line">        <span class="number">0</span>;</div><div class="line">        <span class="comment">//offsetof(ngx_http_hello_loc_conf_t, hello_string), </span></div><div class="line">        <span class="literal">NULL</span>,  </div><div class="line">    &#125;,  </div><div class="line">    ngx_null_command            <span class="comment">// 以一个空的ngx_command_t作为结尾  </span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="hello-set-函数定义"><a href="#hello-set-函数定义" class="headerlink" title="hello set 函数定义"></a>hello set 函数定义</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span>* <span class="title">ngx_http_hello</span><span class="params">(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span>  </span></div><div class="line">&#123;  </div><div class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span> *clcf;  </div><div class="line">    </div><div class="line">    <span class="comment">// 找到hello配置项所属的配置块  </span></div><div class="line">    clcf = ngx_http_conf_get_module_loc_conf(cf, ngx_http_core_module);  </div><div class="line">    </div><div class="line">    <span class="comment">// 设置处理请求的方法，HTTP框架在处理用户请求进行到NGX_HTTP_CONTENT_PHASE阶段时  </span></div><div class="line">    <span class="comment">// 如果主机域名、URI和hello模块所在配置块名称相同，就会调用函数ngx_http_hello_handler  </span></div><div class="line">    clcf-&gt;handler = ngx_http_hello_handler;</div><div class="line">    <span class="comment">//读取字符串类型参数  </span></div><div class="line">    ngx_conf_set_str_slot(cf, cmd, conf);</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> NGX_CONF_OK;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="模块上下文结构"><a href="#模块上下文结构" class="headerlink" title="模块上下文结构"></a>模块上下文结构</h1><p>模块上下文是一个ngx_http_module_t类型的静态变量。这个变量实际上是提供一组回调函数指针，这些函数有在创建存储配置信息的对象的函数，也有在创建前和创建后会调用的函数。这些函数都将被nginx在合适的时间进行调用。</p>
<h2 id="ngx-http-module-t-定义"><a href="#ngx-http-module-t-定义" class="headerlink" title="ngx_http_module_t 定义"></a>ngx_http_module_t 定义</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// 在创建和读取该模块的配置信息之前被调用</span></div><div class="line">    <span class="keyword">ngx_int_t</span>   (*preconfiguration)(<span class="keyword">ngx_conf_t</span> *cf);</div><div class="line">    <span class="comment">// 在创建和读取该模块的配置信息之后被调用</span></div><div class="line">    <span class="keyword">ngx_int_t</span>   (*postconfiguration)(<span class="keyword">ngx_conf_t</span> *cf);</div><div class="line">    <span class="comment">// 调用该函数创建本模块位于http block的配置信息存储结构。该函数成功的时候，返回创建的配置对象。失败的话，返回NULL</span></div><div class="line">    <span class="keyword">void</span>       *(*create_main_conf)(<span class="keyword">ngx_conf_t</span> *cf);</div><div class="line"></div><div class="line">    <span class="keyword">char</span>       *(*init_main_conf)(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">void</span> *conf);</div><div class="line">    <span class="comment">/*</span></div><div class="line">    调用该函数初始化本模块位于http block的配置信息存储结构。该函数成功的时候，返回NGX_CONF_OK。失败的话，返回NGX_CONF_ERROR或错误字符串。</div><div class="line">    */</div><div class="line"></div><div class="line">    <span class="keyword">void</span>       *(*create_srv_conf)(<span class="keyword">ngx_conf_t</span> *cf);</div><div class="line">    <span class="comment">/*</span></div><div class="line">    调用该函数创建本模块位于http server block的配置信息存储结构，每个server block会创建一个。该函数成功的时候，返回创建的配置对象。失败的话，返回NULL。</div><div class="line">    */</div><div class="line"></div><div class="line">    <span class="keyword">char</span>       *(*merge_srv_conf)(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">void</span> *prev, <span class="keyword">void</span> *conf);</div><div class="line">    <span class="comment">/*</span></div><div class="line">    因为有些配置指令既可以出现在http block，也可以出现在http server block中。那么遇到这种情况，每个server都会有自己存储结构来存储该server的配置，但是在这种情况下http block中的配置与server block中的配置信息发生冲突的时候，就需要调用此函数进行合并，该函数并非必须提供，当预计到绝对不会发生需要合并的情况的时候，就无需提供。当然为了安全起见还是建议提供。该函数执行成功的时候，返回NGX_CONF_OK。失败的话，返回NGX_CONF_ERROR或错误字符串。</div><div class="line">    */</div><div class="line"></div><div class="line">    <span class="keyword">void</span>       *(*create_loc_conf)(<span class="keyword">ngx_conf_t</span> *cf);</div><div class="line">    <span class="comment">/*</span></div><div class="line">    调用该函数创建本模块位于location block的配置信息存储结构。每个在配置中指明的location创建一个。该函数执行成功，返回创建的配置对象。失败的话，返回NULL。</div><div class="line">    */</div><div class="line"></div><div class="line">    <span class="comment">// 与 merge_srv_conf 类似。</span></div><div class="line">    <span class="keyword">char</span>       *(*merge_loc_conf)(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">void</span> *prev, <span class="keyword">void</span> *conf);</div><div class="line">&#125; <span class="keyword">ngx_http_module_t</span>;</div></pre></td></tr></table></figure>
<h2 id="hello-上下文结构定义"><a href="#hello-上下文结构定义" class="headerlink" title="hello 上下文结构定义"></a>hello 上下文结构定义</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">ngx_http_module_t</span> ngx_http_hello_module_ctx = &#123;</div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* preconfiguration */</span></div><div class="line">    <span class="literal">NULL</span>,           <span class="comment">/* postconfiguration */</span></div><div class="line"></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* create main configuration */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* init main configuration */</span></div><div class="line"></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* create server configuration */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* merge server configuration */</span></div><div class="line"></div><div class="line">    ngx_http_hello_create_loc_conf, <span class="comment">/* create location configuration */</span></div><div class="line">    ngx_http_hello_merge_loc_conf                        <span class="comment">/* merge location configuration */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h1 id="模块的定义"><a href="#模块的定义" class="headerlink" title="模块的定义"></a>模块的定义</h1><p>每一个模块都需要定义一个ngx_module_t类型的变量来说明这个模块相关信息，比如定义的配置信息、模块的上下文信息，都是通过这个结构来告诉nginx系统的，也就是加载模块的上层代码，都需要通过定义的这个结构，来获取这些信息。</p>
<h2 id="ngx-module-t-定义"><a href="#ngx-module-t-定义" class="headerlink" title="ngx_module_t 定义"></a>ngx_module_t 定义</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> ngx_module_s &#123;  </div><div class="line">    <span class="keyword">ngx_uint_t</span>            ctx_index;    <span class="comment">/* 当前模块在同类模块中的序号 */</span>  </div><div class="line">    <span class="keyword">ngx_uint_t</span>            index;        <span class="comment">/* 当前模块在ngx_modules数组中的序号 */</span>  </div><div class="line">   </div><div class="line">    <span class="keyword">ngx_uint_t</span>            spare0;       <span class="comment">/* 保留 */</span>  </div><div class="line">    <span class="keyword">ngx_uint_t</span>            spare1;       <span class="comment">/* 保留 */</span>  </div><div class="line">    <span class="keyword">ngx_uint_t</span>            spare2;       <span class="comment">/* 保留 */</span>  </div><div class="line">    <span class="keyword">ngx_uint_t</span>            spare3;       <span class="comment">/* 保留 */</span>  </div><div class="line">   </div><div class="line">    <span class="keyword">ngx_uint_t</span>            version;      <span class="comment">/* 模块版本，目前为1 */</span>  </div><div class="line">   </div><div class="line">    <span class="keyword">void</span>                 *ctx;          <span class="comment">/* 指向特定类型模块的公共接口 */</span>  </div><div class="line">    <span class="keyword">ngx_command_t</span>        *commands;     <span class="comment">/* 用于处理配置文件nginx.conf中的配置项 */</span>  </div><div class="line">    <span class="keyword">ngx_uint_t</span>            type;         <span class="comment">/* 当前模块类型 */</span>  </div><div class="line">   </div><div class="line">    <span class="comment">/* 以下7个函数指针表示7个执行点，这些执行点将在Nginx启动和退出过程中被调用 </span></div><div class="line">     * 如果不需要则设置为NULL </div><div class="line">     */  </div><div class="line">    <span class="keyword">ngx_int_t</span>           (*init_master)(<span class="keyword">ngx_log_t</span> *<span class="built_in">log</span>);     <span class="comment">/* 从未被调用，设为NULL */</span>  </div><div class="line">   </div><div class="line">    <span class="keyword">ngx_int_t</span>           (*init_module)(<span class="keyword">ngx_cycle_t</span> *cycle); <span class="comment">/* 启动worker子进程前调用 */</span>  </div><div class="line">   </div><div class="line">    <span class="keyword">ngx_int_t</span>           (*init_process)(<span class="keyword">ngx_cycle_t</span> *cycle);<span class="comment">/* 启动worker子进程后调用 */</span>  </div><div class="line">    <span class="keyword">ngx_int_t</span>           (*init_thread)(<span class="keyword">ngx_cycle_t</span> *cycle); <span class="comment">/* 从未被调用，设为NULL */</span>  </div><div class="line">    <span class="keyword">void</span>                (*exit_thread)(<span class="keyword">ngx_cycle_t</span> *cycle); <span class="comment">/* 从未被调用，设为NULL */</span>  </div><div class="line">    <span class="keyword">void</span>                (*exit_process)(<span class="keyword">ngx_cycle_t</span> *cycle);<span class="comment">/* worker子进程推出前调用 */</span>  </div><div class="line">   </div><div class="line">    <span class="keyword">void</span>                (*exit_master)(<span class="keyword">ngx_cycle_t</span> *cycle); <span class="comment">/* master进程退出前调用 */</span>  </div><div class="line">   </div><div class="line">    <span class="comment">/* 以下全为保留字段 */</span>  </div><div class="line">    <span class="keyword">uintptr_t</span>             spare_hook0;  </div><div class="line">    <span class="keyword">uintptr_t</span>             spare_hook1;  </div><div class="line">    <span class="keyword">uintptr_t</span>             spare_hook2;  </div><div class="line">    <span class="keyword">uintptr_t</span>             spare_hook3;  </div><div class="line">    <span class="keyword">uintptr_t</span>             spare_hook4;  </div><div class="line">    <span class="keyword">uintptr_t</span>             spare_hook5;  </div><div class="line">    <span class="keyword">uintptr_t</span>             spare_hook6;  </div><div class="line">    <span class="keyword">uintptr_t</span>             spare_hook7;  </div><div class="line">&#125;;  </div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NGX_NUMBER_MAJOR  3</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NGX_NUMBER_MINOR  1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NGX_MODULE_V1          0, 0, 0, 0,                              \</span></div><div class="line">    NGX_DSO_ABI_COMPATIBILITY, NGX_NUMBER_MAJOR, NGX_NUMBER_MINOR</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NGX_MODULE_V1_PADDING  0, 0, 0, 0, 0, 0, 0, 0</span></div></pre></td></tr></table></figure>
<h2 id="helloworld-模块定义"><a href="#helloworld-模块定义" class="headerlink" title="helloworld 模块定义"></a>helloworld 模块定义</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ngx_module_t</span> ngx_http_hello_module = &#123;</div><div class="line">    NGX_MODULE_V1,</div><div class="line">    &amp;ngx_http_hello_module_ctx,    <span class="comment">/* module context */</span></div><div class="line">    ngx_http_hello_commands,       <span class="comment">/* module directives */</span></div><div class="line">    NGX_HTTP_MODULE,               <span class="comment">/* module type */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* init master */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* init module */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* init process */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* init thread */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* exit thread */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* exit process */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* exit master */</span></div><div class="line">    NGX_MODULE_V1_PADDING</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h1 id="handler-的定义"><a href="#handler-的定义" class="headerlink" title="handler 的定义"></a>handler 的定义</h1><p>handler模块必须提供一个真正的处理函数，这个函数负责对来自客户端请求的真正处理。这个函数的处理，既可以选择自己直接生成内容，也可以选择拒绝处理，由后续的handler去进行处理，或者是选择丢给后续的filter进行处理。来看一下这个函数的原型申明。</p>
<h2 id="handler-原型"><a href="#handler-原型" class="headerlink" title="handler 原型"></a>handler 原型</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ngx_int_t</span> <span class="params">(*ngx_http_handler_pt)</span><span class="params">(<span class="keyword">ngx_http_request_t</span> *r)</span></span>;</div><div class="line"></div><div class="line">r是http请求,里面包含请求所有的信息。 该函数处理成功返回NGX_OK，处理发生错误返回NGX_ERROR，拒绝处理（留给后续的handler进行处理）返回NGX_DECLINE。 返回NGX_OK也就代表给客户端的响应已经生成好了，否则返回NGX_ERROR就发生错误了。</div></pre></td></tr></table></figure>
<h1 id="handler-挂载"><a href="#handler-挂载" class="headerlink" title="handler 挂载"></a>handler 挂载</h1><p>hello模块的handler挂在在set函数中完成了挂载。</p>
<h2 id="hello-模块-handler-定义"><a href="#hello-模块-handler-定义" class="headerlink" title="hello 模块 handler 定义"></a>hello 模块 handler 定义</h2><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">static ngx_int_t ngx_http_hello_handler(ngx_http_request_t* r) &#123;</div><div class="line">    ngx_int_t rc;</div><div class="line">    ngx_buf_t* b;</div><div class="line">    <span class="comment">//构造发送时的ngx_chain_t结构体</span></div><div class="line">    ngx_chain_t out[<span class="number">2</span>];</div><div class="line"></div><div class="line">    ngx_http_hello_world_loc_conf_t* hlcf;</div><div class="line">    hlcf = ngx_http_get_module_loc_conf(r, ngx_http_hello_world_module);</div><div class="line"></div><div class="line">    <span class="comment">/* allocate a buffer for your response body */</span></div><div class="line">    <span class="function"><span class="title">b</span> = ngx_pcalloc(r-&gt;</span>pool, sizeof(ngx_buf_t));</div><div class="line">    <span class="keyword">if</span> (b == NULL) &#123;</div><div class="line">            return NGX_HTTP_INTERNAL_SERVER_ERROR;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    out[<span class="number">0</span>].buf = b;</div><div class="line">    out[<span class="number">0</span>].next = &amp;out[<span class="number">1</span>];</div><div class="line"></div><div class="line">    <span class="function"><span class="title">b</span>-&gt;</span>pos = (u_char*)<span class="string">"hello, "</span>;</div><div class="line">    <span class="comment">//设置last指针</span></div><div class="line">    <span class="function"><span class="title">b</span>-&gt;</span><span class="function"><span class="title">last</span> = b-&gt;</span>pos + sizeof(<span class="string">"hello, "</span>) - <span class="number">1</span>;</div><div class="line">    <span class="comment">/* this buffer is in memory */</span></div><div class="line">    <span class="function"><span class="title">b</span>-&gt;</span>memory = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="title">b</span> = ngx_pcalloc(r-&gt;</span>pool, sizeof(ngx_buf_t));</div><div class="line">    <span class="keyword">if</span> (b == NULL) &#123;</div><div class="line">            return NGX_HTTP_INTERNAL_SERVER_ERROR;</div><div class="line">    &#125;</div><div class="line">    out[<span class="number">1</span>].buf = b;</div><div class="line">    out[<span class="number">1</span>].next = NULL;</div><div class="line"></div><div class="line">    <span class="comment">//获得hello指定的参数值</span></div><div class="line">    <span class="function"><span class="title">b</span>-&gt;</span><span class="function"><span class="title">pos</span> = hlcf-&gt;</span>hello_string.<span class="keyword">data</span>;</div><div class="line">    <span class="function"><span class="title">b</span>-&gt;</span><span class="function"><span class="title">last</span> = hlcf-&gt;</span><span class="function"><span class="title">hello_string</span>.<span class="keyword">data</span> + (hlcf-&gt;</span>hello_string.len);</div><div class="line">    <span class="function"><span class="title">b</span>-&gt;</span>memory = <span class="number">1</span>;</div><div class="line">    <span class="comment">//声明这是最后一块缓冲区</span></div><div class="line">    <span class="function"><span class="title">b</span>-&gt;</span>last_buf = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">//设置响应体头部</span></div><div class="line">    <span class="function"><span class="title">r</span>-&gt;</span>headers_out.status = NGX_HTTP_OK;</div><div class="line">    <span class="comment">//设置Content-Type</span></div><div class="line">    <span class="function"><span class="title">ngx_str_set</span>(&amp;r-&gt;</span>headers_out.content_type, <span class="string">"text/html"</span>);</div><div class="line">    <span class="comment">//响应包是有包体内容的，所以需要设置Content-Length长度</span></div><div class="line">    <span class="function"><span class="title">r</span>-&gt;</span><span class="function"><span class="title">headers_out</span>.content_length_n =  sizeof("hello, ") + hlcf-&gt;</span>hello_string.len - <span class="number">1</span>;</div><div class="line">    <span class="comment">//发送http头部</span></div><div class="line">    rc = ngx_http_send_header(r);</div><div class="line">    <span class="function"><span class="title">if</span> (rc == NGX_ERROR || rc &gt; NGX_OK || r-&gt;</span>header_only) &#123;</div><div class="line">        return rc;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 向用户发送响应包  </span></div><div class="line">    return ngx_http_output_filter(r, &amp;out[<span class="number">0</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="模块编译使用"><a href="#模块编译使用" class="headerlink" title="模块编译使用"></a>模块编译使用</h1><h2 id="config文件"><a href="#config文件" class="headerlink" title="config文件"></a>config文件</h2><p>对于开发一个模块，我们是需要把这个模块的C代码组织到一个目录里，同时需要编写一个config文件。这个config文件的内容就是告诉nginx的编译脚本，该如何进行编译。<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attr">ngx_addon_name</span>=ngx_http_hello_module</div><div class="line"><span class="attr">HTTP_MODULES</span>=<span class="string">"$HTTP_MODULES ngx_http_hello_module"</span></div><div class="line"><span class="attr">NGX_ADDON_SRCS</span>=<span class="string">"$NGX_ADDON_SRCS $ngx_addon_dir/ngx_http_hello_module.c"</span></div></pre></td></tr></table></figure></p>
<p>其实文件很简单，几乎不需要做什么解释。大家一看都懂了。唯一需要说明的是，如果这个模块的实现有多个源文件，那么都在NGX_ADDON_SRCS这个变量里，依次写进去就可以。</p>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>对于模块的编译，nginx并不像apache一样，提供了单独的编译工具，可以在没有apache源代码的情况下来单独编译一个模块的代码。nginx必须去到nginx的源代码目录里，通过configure指令的参数，来进行编译。下面看一下hello module的configure指令：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">.<span class="regexp">/configure –prefix=/u</span>sr<span class="regexp">/local/</span>nginx –add-module=<span class="regexp">/your/m</span>odule<span class="regexp">/path/</span>ngx_http_hello_world_module</div><div class="line">make</div></pre></td></tr></table></figure></p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>nginx 配置如下：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">location</span> <span class="title">/hello</span> &#123;</div><div class="line">                hello_string world;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>访问 <a href="http://127.0.0.1/hello的时候，就可以看到页面显示&quot;hello" target="_blank" rel="external">http://127.0.0.1/hello的时候，就可以看到页面显示&quot;hello</a>, world”。</p>
<h1 id="完整的-helloXX-模块代码"><a href="#完整的-helloXX-模块代码" class="headerlink" title="完整的 helloXX 模块代码"></a>完整的 helloXX 模块代码</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div></pre></td><td class="code"><pre><div class="line">include &lt;ngx_config.h&gt;</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ngx_core.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ngx_http.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span>* <span class="title">ngx_http_hello</span><span class="params">(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span>* <span class="title">ngx_http_hello_create_loc_conf</span><span class="params">(<span class="keyword">ngx_conf_t</span>* cf)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span>* <span class="title">ngx_http_hello_merge_loc_conf</span><span class="params">(<span class="keyword">ngx_conf_t</span>* cf, <span class="keyword">void</span>* parent, <span class="keyword">void</span>* child)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> ngx_int_t <span class="title">ngx_http_hello_handler</span><span class="params">(<span class="keyword">ngx_http_request_t</span>* r)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">ngx_str_t</span> hello_string;</div><div class="line">&#125;<span class="keyword">ngx_http_hello_loc_conf_t</span>;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">ngx_command_t</span> ngx_http_hello_commands[] = &#123;  </div><div class="line">    &#123;  </div><div class="line">        ngx_string(<span class="string">"hello_string"</span>),  </div><div class="line">        NGX_HTTP_MAIN_CONF | NGX_HTTP_SRV_CONF | NGX_HTTP_LOC_CONF | NGX_HTTP_LMT_CONF | NGX_CONF_NOARGS,  </div><div class="line">        ngx_http_hello,        <span class="comment">// 出现hello配置项时，调用ngx_http_hello解析  </span></div><div class="line">        NGX_HTTP_LOC_CONF_OFFSET,  </div><div class="line">        <span class="comment">// ngx_http_hello_loc_conf_t 为模块配置信息结构</span></div><div class="line">        <span class="number">0</span>;</div><div class="line">        <span class="comment">//offsetof(ngx_http_hello_loc_conf_t, hello_string), </span></div><div class="line">        <span class="literal">NULL</span>,  </div><div class="line">    &#125;,  </div><div class="line">    ngx_null_command            <span class="comment">// 以一个空的ngx_command_t作为结尾  </span></div><div class="line">&#125;;  </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span>* <span class="title">ngx_http_hello</span><span class="params">(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd, <span class="keyword">void</span> *conf)</span>  </span></div><div class="line">&#123;  </div><div class="line">    <span class="keyword">ngx_http_core_loc_conf_t</span> *clcf;  </div><div class="line">    </div><div class="line">    <span class="comment">// 找到hello配置项所属的配置块  </span></div><div class="line">    clcf = ngx_http_conf_get_module_loc_conf(cf, ngx_http_core_module);  </div><div class="line">    </div><div class="line">    <span class="comment">// 设置处理请求的方法，HTTP框架在处理用户请求进行到NGX_HTTP_CONTENT_PHASE阶段时  </span></div><div class="line">    <span class="comment">// 如果主机域名、URI和hello模块所在配置块名称相同，就会调用函数ngx_http_hello_handler  </span></div><div class="line">    clcf-&gt;handler = ngx_http_hello_handler;</div><div class="line">    <span class="comment">//读取字符串类型参数  </span></div><div class="line">    ngx_conf_set_str_slot(cf, cmd, conf);</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> NGX_CONF_OK;  </div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="keyword">ngx_module_t</span> ngx_http_hello_module = &#123;</div><div class="line">    NGX_MODULE_V1,</div><div class="line">    &amp;ngx_http_hello_module_ctx,    <span class="comment">/* module context */</span></div><div class="line">    ngx_http_hello_commands,       <span class="comment">/* module directives */</span></div><div class="line">    NGX_HTTP_MODULE,               <span class="comment">/* module type */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* init master */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* init module */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* init process */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* init thread */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* exit thread */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* exit process */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* exit master */</span></div><div class="line">    NGX_MODULE_V1_PADDING</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">ngx_http_module_t</span> ngx_http_hello_module_ctx = &#123;</div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* preconfiguration */</span></div><div class="line">    <span class="literal">NULL</span>,           <span class="comment">/* postconfiguration */</span></div><div class="line"></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* create main configuration */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* init main configuration */</span></div><div class="line"></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* create server configuration */</span></div><div class="line">    <span class="literal">NULL</span>,                          <span class="comment">/* merge server configuration */</span></div><div class="line"></div><div class="line">    ngx_http_hello_create_loc_conf, <span class="comment">/* create location configuration */</span></div><div class="line">    ngx_http_hello_merge_loc_conf                        <span class="comment">/* merge location configuration */</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ngx_int_t <span class="title">ngx_http_hello_handler</span><span class="params">(<span class="keyword">ngx_http_request_t</span>* r)</span> </span>&#123;</div><div class="line">    <span class="keyword">ngx_int_t</span> rc;</div><div class="line">    <span class="keyword">ngx_buf_t</span>* b;</div><div class="line">    <span class="comment">//构造发送时的ngx_chain_t结构体</span></div><div class="line">    <span class="keyword">ngx_chain_t</span> out[<span class="number">2</span>];</div><div class="line"></div><div class="line">    <span class="keyword">ngx_http_hello_world_loc_conf_t</span>* hlcf;</div><div class="line">    hlcf = ngx_http_get_module_loc_conf(r, ngx_http_hello_world_module);</div><div class="line"></div><div class="line">    <span class="comment">/* allocate a buffer for your response body */</span></div><div class="line">    b = ngx_pcalloc(r-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_buf_t</span>));</div><div class="line">    <span class="keyword">if</span> (b == <span class="literal">NULL</span>) &#123;</div><div class="line">            <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    out[<span class="number">0</span>].buf = b;</div><div class="line">    out[<span class="number">0</span>].next = &amp;out[<span class="number">1</span>];</div><div class="line"></div><div class="line">    b-&gt;pos = (u_char*)<span class="string">"hello, "</span>;</div><div class="line">    <span class="comment">//设置last指针</span></div><div class="line">    b-&gt;last = b-&gt;pos + <span class="keyword">sizeof</span>(<span class="string">"hello, "</span>) - <span class="number">1</span>;</div><div class="line">    <span class="comment">/* this buffer is in memory */</span></div><div class="line">    b-&gt;memory = <span class="number">1</span>;</div><div class="line"></div><div class="line">    b = ngx_pcalloc(r-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_buf_t</span>));</div><div class="line">    <span class="keyword">if</span> (b == <span class="literal">NULL</span>) &#123;</div><div class="line">            <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</div><div class="line">    &#125;</div><div class="line">    out[<span class="number">1</span>].buf = b;</div><div class="line">    out[<span class="number">1</span>].next = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    <span class="comment">//获得hello指定的参数值</span></div><div class="line">    b-&gt;pos = hlcf-&gt;hello_string.data;</div><div class="line">    b-&gt;last = hlcf-&gt;hello_string.data + (hlcf-&gt;hello_string.len);</div><div class="line">    b-&gt;memory = <span class="number">1</span>;</div><div class="line">    <span class="comment">//声明这是最后一块缓冲区</span></div><div class="line">    b-&gt;last_buf = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">//设置响应体头部</span></div><div class="line">    r-&gt;headers_out.status = NGX_HTTP_OK;</div><div class="line">    <span class="comment">//设置Content-Type</span></div><div class="line">    ngx_str_set(&amp;r-&gt;headers_out.content_type, <span class="string">"text/html"</span>);</div><div class="line">    <span class="comment">//响应包是有包体内容的，所以需要设置Content-Length长度</span></div><div class="line">    r-&gt;headers_out.content_length_n =  <span class="keyword">sizeof</span>(<span class="string">"hello, "</span>) + hlcf-&gt;hello_string.len - <span class="number">1</span>;</div><div class="line">    <span class="comment">//发送http头部</span></div><div class="line">    rc = ngx_http_send_header(r);</div><div class="line">    <span class="keyword">if</span> (rc == NGX_ERROR || rc &gt; NGX_OK || r-&gt;header_only) &#123;</div><div class="line">        <span class="keyword">return</span> rc;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 向用户发送响应包  </span></div><div class="line">    <span class="keyword">return</span> ngx_http_output_filter(r, &amp;out[<span class="number">0</span>]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span>* <span class="title">ngx_http_hello_create_loc_conf</span><span class="params">(<span class="keyword">ngx_conf_t</span>* cf)</span> </span>&#123;</div><div class="line">    <span class="keyword">ngx_http_hello_world_loc_conf_t</span>* conf;</div><div class="line"></div><div class="line">    conf = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_hello_world_loc_conf_t</span>));</div><div class="line">    <span class="keyword">if</span> (conf == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</div><div class="line">    &#125;</div><div class="line">    conf-&gt;hello_string.len = <span class="number">0</span>;</div><div class="line">    conf-&gt;hello_string.data = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> conf;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span>* <span class="title">ngx_http_hello_merge_loc_conf</span><span class="params">(<span class="keyword">ngx_conf_t</span>* cf, <span class="keyword">void</span>* parent, <span class="keyword">void</span>* child)</span> </span>&#123;</div><div class="line">    <span class="keyword">ngx_http_hello_world_loc_conf_t</span>* prev = parent;</div><div class="line">    <span class="keyword">ngx_http_hello_world_loc_conf_t</span>* conf = child;</div><div class="line">    ngx_conf_merge_str_value(conf-&gt;hello_string, prev-&gt;hello_string, <span class="string">"Nginx"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> NGX_CONF_OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="http://tengine.taobao.org/book/chapter_03.html" target="_blank" rel="external">http://tengine.taobao.org/book/chapter_03.html</a><br><a href="http://blog.csdn.net/nestler/article/details/31825335" target="_blank" rel="external">http://blog.csdn.net/nestler/article/details/31825335</a><br><a href="http://blog.csdn.net/poechant/article/details/7627828" target="_blank" rel="external">http://blog.csdn.net/poechant/article/details/7627828</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="http://7xum8m.com1.z0.glb.clouddn.com/pay_wechat_pay.jpg" alt="sword2g WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="http://7xum8m.com1.z0.glb.clouddn.com/pay_ali_pay.jpg" alt="sword2g Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Nginx/" rel="tag"># Nginx</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/09/16/nginx-datastructure-ngx_chain_t-ngx_buf_t/" rel="next" title="Nginx 基础数据结构(二)">
                <i class="fa fa-chevron-left"></i> Nginx 基础数据结构(二)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/09/17/nginx-datastructure-ngx_array_t/" rel="prev" title="Nginx 基础数据结构(三)">
                Nginx 基础数据结构(三) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/09/17/nginx-module-dev/"
           data-title="Nginx 模块开发————Hello XX" data-url="https://github.com/Sword2G/sword2g.github.io/2016/09/17/nginx-module-dev/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://7xum8m.com1.z0.glb.clouddn.com/avataravatar.jpg"
               alt="sword2g" />
          <p class="site-author-name" itemprop="name">sword2g</p>
           
              <p class="site-description motion-element" itemprop="description">put my notes here</p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="http://sword2g.github.io/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Sword2G" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/2816511392" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/97199972/" target="_blank" title="豆瓣">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  豆瓣
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/birkhoff-lee" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://my.oschina.net/v5871314" title="梦回雪夜观花" target="_blank">梦回雪夜观花</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#模块配置结构"><span class="nav-number">1.</span> <span class="nav-text">模块配置结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#模块配置指令（commands-数组）"><span class="nav-number">2.</span> <span class="nav-text">模块配置指令（commands 数组）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-command-t-定义"><span class="nav-number">2.1.</span> <span class="nav-text">ngx_command_t 定义</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#conf-参数"><span class="nav-number">2.1.1.</span> <span class="nav-text">conf 参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#offset-参数"><span class="nav-number">2.1.2.</span> <span class="nav-text">offset 参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hello-commands-数组定义"><span class="nav-number">2.2.</span> <span class="nav-text">hello commands 数组定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hello-set-函数定义"><span class="nav-number">2.3.</span> <span class="nav-text">hello set 函数定义</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#模块上下文结构"><span class="nav-number">3.</span> <span class="nav-text">模块上下文结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-http-module-t-定义"><span class="nav-number">3.1.</span> <span class="nav-text">ngx_http_module_t 定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hello-上下文结构定义"><span class="nav-number">3.2.</span> <span class="nav-text">hello 上下文结构定义</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#模块的定义"><span class="nav-number">4.</span> <span class="nav-text">模块的定义</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-module-t-定义"><span class="nav-number">4.1.</span> <span class="nav-text">ngx_module_t 定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#helloworld-模块定义"><span class="nav-number">4.2.</span> <span class="nav-text">helloworld 模块定义</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#handler-的定义"><span class="nav-number">5.</span> <span class="nav-text">handler 的定义</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#handler-原型"><span class="nav-number">5.1.</span> <span class="nav-text">handler 原型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#handler-挂载"><span class="nav-number">6.</span> <span class="nav-text">handler 挂载</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#hello-模块-handler-定义"><span class="nav-number">6.1.</span> <span class="nav-text">hello 模块 handler 定义</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#模块编译使用"><span class="nav-number">7.</span> <span class="nav-text">模块编译使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#config文件"><span class="nav-number">7.1.</span> <span class="nav-text">config文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编译"><span class="nav-number">7.2.</span> <span class="nav-text">编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用"><span class="nav-number">7.3.</span> <span class="nav-text">使用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#完整的-helloXX-模块代码"><span class="nav-number">8.</span> <span class="nav-text">完整的 helloXX 模块代码</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">9.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        

<div align="center" class="powered-by">

  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a> 
  and Themed by -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist</a>


  &copy;  2015 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sword2g</span>
  
</div>






        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"sword2g"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  

  


  

</body>
</html>
